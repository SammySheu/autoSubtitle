<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Upload</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="app">
        <div class="form-section">
            <form action="/upload-video" id="form-section" method="POST" enctype="multipart/form-data">
                <input type="file" id="file" name="file_from_user" required>
                <input type="submit" value="Upload">
            </form>
        </div>
        <div class="files-section" id="files-section">
            {% for video in videos %}
                <!-- <a href="">
                    <img src="{{ url_for('display_files', filename=video) }}">
                </a> -->
                <div class="single-video">
                    <video src="{{ url_for('display_files', filename=video) }}" controls preload="preload"></video>
                    <form action="/add-subtitles" class="user-video" method="POST">
                        <input type="submit" name="generate-subtitles" value="Add Subtitles">
                    </form>
                </div>
            {% endfor %}
        </div>
        <form action="/logout" method="POST">
            <button type="submit">Logout</button>
        </form>
    </div>
    <script>
        const formSection = document.getElementById('form-section')
        formSection.addEventListener('submit', upload)
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            console.log(value)
            const parts = value.split(`; ${name}=`);
            console.log(parts)
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const fetchOptions = (argPutInBody) => {
            return {
                method: 'post',
                credentials: 'same-origin',
                headers: {
                    'X-CSRF-TOKEN': getCookie('csrf_access_token'),
                },
            body: argPutInBody,
            }
        }
        async function upload(e){
            e.preventDefault();
            console.log()
            const userFile = document.getElementById('file').files[0];
            const formData = new FormData();
            formData.append('file_from_user', userFile)
            const response = await fetch('http://127.0.0.1:5555/upload-video', fetchOptions(formData));
            const result = await response.json();
            location.reload()
            return result;
        }
        const fileSection = document.getElementById('files-section')
        fileSection.addEventListener('submit', addSubtitle)
        async function addSubtitle(e){
            e.preventDefault();
            videoName = e.target.parentNode.querySelector('video').src
            video_name = videoName.slice(33).split('.mp4')[0]
            console.log(video_name)
            const response = await fetch('http://127.0.0.1:5555/add-subtitles', fetchOptions(JSON.stringify(video_name)));
            const result = await response.json();
            location.reload()
            return result;
            
        }
    </script>
</body>
</html>